# üîé Host Vulnerability Search Guide

This guide provides comprehensive documentation for the new `search_hosts_by_vulnerabilities` MCP tool, which enables searching for hosts based on their vulnerabilities using CrowdStrike Spotlight.

## Table of Contents

1. [Overview](#overview)
2. [Quick Start](#quick-start) 
3. [Tool Parameters](#tool-parameters)
4. [Vulnerability Filter Examples](#vulnerability-filter-examples)
5. [Practical Use Cases](#practical-use-cases)
6. [Output Formats](#output-formats)
7. [Advanced Techniques](#advanced-techniques)
8. [Performance Considerations](#performance-considerations)
9. [Troubleshooting](#troubleshooting)

## Overview

The `search_hosts_by_vulnerabilities` tool bridges CrowdStrike's Spotlight Vulnerabilities service with Host management, enabling you to:

- **Find hosts affected by specific CVEs** (e.g., CVE-2024-1234)
- **Identify systems with critical vulnerabilities** 
- **Locate hosts with open security issues**
- **Analyze vulnerability exposure across environments**
- **Prioritize remediation efforts** based on severity and exploitability

### How It Works

1. **Vulnerability Search**: Queries Spotlight Vulnerabilities service with your criteria
2. **Host Extraction**: Extracts unique host identifiers (AIDs) from vulnerability results
3. **Host Details**: Retrieves comprehensive host information for affected systems
4. **Combined Analysis**: Provides unified view of vulnerability and host data

## Quick Start

### Basic Examples

```python
# Find hosts with a specific CVE
search_hosts_by_vulnerabilities("cve.id:['CVE-2024-1234']")

# Find hosts with open critical vulnerabilities
search_hosts_by_vulnerabilities("status:'open'+cve.severity:'CRITICAL'")

# Find Windows hosts with high-severity vulnerabilities
search_hosts_by_vulnerabilities("host_info.platform_name:'Windows'+cve.severity:'HIGH'")
```

## Tool Parameters

```python
search_hosts_by_vulnerabilities(
    vulnerability_filter="",           # FQL filter for vulnerability search
    limit=100,                        # Max vulnerabilities to process (1-1000)
    sort="created_timestamp.desc",    # Sort order for vulnerabilities
    include_host_details=False,       # Include full host information
    include_vulnerability_details=False  # Include detailed vulnerability info
)
```

### Supported Sort Options

The Spotlight Vulnerabilities API supports sorting by these timestamp properties only:

- `"created_timestamp.desc"` - Newest vulnerabilities first (default)
- `"created_timestamp.asc"` - Oldest vulnerabilities first  
- `"updated_timestamp.desc"` - Most recently updated first
- `"updated_timestamp.asc"` - Least recently updated first
- `"closed_timestamp.desc"` - Most recently closed first
- `"closed_timestamp.asc"` - Earliest closed first

**Note**: Unlike other APIs, you cannot sort by CVE properties like `base_score` or `severity`. Use timestamp-based sorting for prioritization.

### Parameter Details

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `vulnerability_filter` | str | `""` | FQL expression using Spotlight Vulnerabilities syntax |
| `limit` | int | `100` | Maximum vulnerabilities to process (affects performance) |
| `sort` | str | `"created_timestamp.desc"` | Sort vulnerabilities by timestamp (created_timestamp, closed_timestamp, updated_timestamp) |
| `include_host_details` | bool | `False` | Show comprehensive host information |
| `include_vulnerability_details` | bool | `False` | Show detailed vulnerability information |

## Vulnerability Filter Examples

### CVE-Specific Searches

```python
# Single specific CVE
search_hosts_by_vulnerabilities("cve.id:['CVE-2024-1234']")

# Multiple CVEs
search_hosts_by_vulnerabilities("cve.id:['CVE-2024-1234','CVE-2024-5678']")

# Exclude specific CVEs
search_hosts_by_vulnerabilities("cve.id:!['CVE-2024-1234','CVE-2024-5678']")
```

### Severity-Based Searches

```python
# Critical vulnerabilities only
search_hosts_by_vulnerabilities("cve.severity:'CRITICAL'")

# High or critical vulnerabilities
search_hosts_by_vulnerabilities("cve.severity:['HIGH','CRITICAL']")

# Any severity except low
search_hosts_by_vulnerabilities("cve.severity:!'LOW'")
```

### Status-Based Searches

```python
# Open vulnerabilities only
search_hosts_by_vulnerabilities("status:'open'")

# Open critical vulnerabilities
search_hosts_by_vulnerabilities("status:'open'+cve.severity:'CRITICAL'")

# Recently closed vulnerabilities
search_hosts_by_vulnerabilities("status:'closed'+closed_timestamp:>'2024-01-15T00:00:00Z'")
```

### Exploit-Based Searches

```python
# Actively exploited vulnerabilities (exploit status 90)
search_hosts_by_vulnerabilities("cve.exploit_status:'90'")

# Any known exploits (not unproven)
search_hosts_by_vulnerabilities("cve.exploit_status:!'0'")

# CISA Known Exploited Vulnerabilities
search_hosts_by_vulnerabilities("cve.is_cisa_kev:true")
```

### Platform-Specific Searches

```python
# Windows hosts with vulnerabilities
search_hosts_by_vulnerabilities("host_info.platform_name:'Windows'")

# Linux servers with critical vulnerabilities
search_hosts_by_vulnerabilities("host_info.platform_name:'Linux'+cve.severity:'CRITICAL'")

# Internet-exposed hosts with vulnerabilities
search_hosts_by_vulnerabilities("host_info.internet_exposure:'Yes'")
```

### Time-Based Searches

```python
# Recently discovered vulnerabilities (last 30 days)
search_hosts_by_vulnerabilities("created_timestamp:>'2024-01-15T00:00:00Z'")

# Old unpatched vulnerabilities
search_hosts_by_vulnerabilities("created_timestamp:<'2023-01-01T00:00:00Z'+status:'open'")

# Vulnerabilities updated in last week
search_hosts_by_vulnerabilities("updated_timestamp:>'2024-01-15T00:00:00Z'")
```

## Practical Use Cases

### 1. Emergency Response

```python
# Critical vulnerability outbreak response
search_hosts_by_vulnerabilities(
    "cve.id:['CVE-2024-CRITICAL']+status:'open'",
    include_host_details=True,
    include_vulnerability_details=True
)

# Actively exploited vulnerabilities requiring immediate action
search_hosts_by_vulnerabilities(
    "cve.exploit_status:'90'+status:'open'",
    sort="created_timestamp.desc"
)
```

### 2. Compliance & Risk Assessment

```python
# CISA KEV compliance check
search_hosts_by_vulnerabilities(
    "cve.is_cisa_kev:true+status:'open'",
    limit=500
)

# High-risk internet-exposed systems
search_hosts_by_vulnerabilities(
    "host_info.internet_exposure:'Yes'+cve.severity:['HIGH','CRITICAL']+status:'open'"
)
```

### 3. Patch Management

```python
# Windows systems needing critical patches
search_hosts_by_vulnerabilities(
    "host_info.platform_name:'Windows'+cve.severity:'CRITICAL'+status:'open'",
    sort="created_timestamp.asc"  # Oldest vulnerabilities first
)

# Production systems with open vulnerabilities
search_hosts_by_vulnerabilities(
    "host_info.tags:['production']+status:'open'+cve.severity:['HIGH','CRITICAL']"
)
```

### 4. Asset Management

```python
# Unmanaged assets with vulnerabilities
search_hosts_by_vulnerabilities(
    "host_info.managed_by:'Unmanaged'+cve.severity:['HIGH','CRITICAL']"
)

# Critical assets with any vulnerabilities
search_hosts_by_vulnerabilities(
    "host_info.asset_criticality:['Critical','High']"
)
```

## Output Formats

### Summary View (Default)

```
# üîé CrowdStrike Falcon - Hosts by Vulnerabilities Search Results

## üéØ Search Parameters
‚Ä¢ Vulnerability Filter: status:'open'+cve.severity:'CRITICAL'
‚Ä¢ Limit: 100 vulnerabilities
‚Ä¢ Sort: created_timestamp.desc

## üìä Results Summary
‚Ä¢ Vulnerabilities Found: 25
‚Ä¢ Unique Hosts Affected: 12

## üìà Vulnerability Analysis
### Severity Distribution
‚Ä¢ CRITICAL: 25 vulnerabilities

### Status Distribution
‚Ä¢ open: 25 vulnerabilities

### Platform Distribution
‚Ä¢ Windows: 18 vulnerabilities
‚Ä¢ Linux: 7 vulnerabilities

## üñ•Ô∏è Affected Hosts
### Host Summary
#   Hostname                  Platform   Vuln Count Most Severe  Host ID
1   web-server-01            Windows    3          CRITICAL      a1b2c3d4...
2   db-primary-prod          Linux      2          CRITICAL      e5f6g7h8...
```

### Detailed View (include_host_details=True)

```
--- Host #1: web-server-01 ---
Host ID (AID): a1b2c3d4e5f6g7h8...
Platform: Windows
Vulnerabilities: 3

Host Details:
# CrowdStrike Falcon Host Technical Details
## Basic Information
‚Ä¢ Hostname: web-server-01
‚Ä¢ Host ID (AID): a1b2c3d4e5f6g7h8...
‚Ä¢ Computer Name: WEB-SERVER-01
‚Ä¢ Status: normal
‚Ä¢ Agent Version: 7.10.0
...
```

### Vulnerability Details (include_vulnerability_details=True)

```
Vulnerability Details for web-server-01:

  Vulnerability #1:
    Vulnerability ID: CSVM-12345
    Status: open
    Confidence: confirmed
    CVE ID: CVE-2024-1234
    Severity: CRITICAL
    Base Score: 9.8
    Exploit Status: 90
    CISA KEV: Yes
    Created: 2024-01-15 14:30:00 UTC
    Updated: 2024-01-16 09:15:00 UTC
```

## Advanced Techniques

### Complex Multi-Criteria Searches

```python
# Critical production vulnerabilities with known exploits
search_hosts_by_vulnerabilities(
    "cve.severity:'CRITICAL'+status:'open'+host_info.tags:['production']+cve.exploit_status:!'0'"
)

# Internet-exposed Windows servers with CISA KEV vulnerabilities
search_hosts_by_vulnerabilities(
    "cve.is_cisa_kev:true+host_info.internet_exposure:'Yes'+host_info.platform_name:'Windows'"
)

# Old unpatched vulnerabilities on critical assets
search_hosts_by_vulnerabilities(
    "created_timestamp:<'2023-06-01T00:00:00Z'+status:'open'+host_info.asset_criticality:['Critical','High']"
)
```

### Risk Prioritization

```python
# Highest risk: Critical + Exploited + Internet-exposed
search_hosts_by_vulnerabilities(
    "cve.severity:'CRITICAL'+cve.exploit_status:['60','90']+host_info.internet_exposure:'Yes'",
    sort="created_timestamp.desc",
    include_host_details=True
)

# ExPRT high-rated vulnerabilities
search_hosts_by_vulnerabilities(
    "cve.exprt_rating:['HIGH','CRITICAL']+status:'open'",
    sort="created_timestamp.desc"
)
```

### Environment-Specific Searches

```python
# Development vs Production vulnerability comparison
# Development
search_hosts_by_vulnerabilities(
    "host_info.tags:['development']+status:'open'"
)

# Production
search_hosts_by_vulnerabilities(
    "host_info.tags:['production']+status:'open'"
)
```

## Performance Considerations

### Optimizing Large Searches

1. **Use specific filters** to reduce result sets
2. **Limit appropriately** - higher limits take longer to process
3. **Avoid full details** for large result sets
4. **Focus on priority criteria** first

### Efficient Filtering Strategies

```python
# Good: Specific severity and status
search_hosts_by_vulnerabilities("cve.severity:'CRITICAL'+status:'open'")

# Better: Add platform filter
search_hosts_by_vulnerabilities("cve.severity:'CRITICAL'+status:'open'+host_info.platform_name:'Windows'")

# Best: Add time constraints for recent vulnerabilities
search_hosts_by_vulnerabilities("cve.severity:'CRITICAL'+status:'open'+host_info.platform_name:'Windows'+created_timestamp:>'2024-01-01T00:00:00Z'")
```

### Batch Processing for Large Environments

```python
# Process by platform
platforms = ['Windows', 'Linux', 'Mac']
for platform in platforms:
    results = search_hosts_by_vulnerabilities(
        f"host_info.platform_name:'{platform}'+cve.severity:'CRITICAL'+status:'open'",
        limit=200
    )
    # Process platform-specific results
```

## Troubleshooting

### Common Issues

**No results returned:**
- Verify vulnerability filter syntax
- Check CVE ID format: `cve.id:['CVE-YYYY-NNNN']`
- Ensure proper quoting: use single quotes around values
- Consider if `status:'open'` is filtering out closed vulnerabilities

**Syntax errors:**
- Use single quotes: `cve.severity:'CRITICAL'` not `cve.severity:"CRITICAL"`
- Check operator placement: `cve.severity:!'LOW'` not `cve.severity!:'LOW'`
- Verify date format: `'YYYY-MM-DDTHH:MM:SSZ'` in UTC
- Balance parentheses in complex expressions

**Performance issues:**
- Reduce limit for exploratory searches
- Use specific filters to narrow scope
- Avoid `include_*_details=True` for large result sets
- Focus on recent vulnerabilities with time filters

**Sort errors:**
- Only timestamp properties are supported for sorting
- Cannot sort by `cve.base_score`, `cve.severity`, or `cve.exprt_rating`
- Use `created_timestamp.desc`, `updated_timestamp.desc`, or `closed_timestamp.desc`
- For risk prioritization, use severity filters instead of sorting

### Debugging Tips

```python
# Start with broad search to verify connectivity
search_hosts_by_vulnerabilities("status:'open'", limit=10)

# Test specific CVE
search_hosts_by_vulnerabilities("cve.id:['CVE-2024-1234']", limit=5)

# Build complexity gradually
search_hosts_by_vulnerabilities("cve.severity:'CRITICAL'", limit=10)
search_hosts_by_vulnerabilities("cve.severity:'CRITICAL'+status:'open'", limit=10)
search_hosts_by_vulnerabilities("cve.severity:'CRITICAL'+status:'open'+host_info.platform_name:'Windows'", limit=10)
```

### Validation Steps

```python
# Check what vulnerabilities exist
search_hosts_by_vulnerabilities("", limit=10, include_vulnerability_details=True)

# Verify host information is available
search_hosts_by_vulnerabilities("host_info.platform_name:'Windows'", limit=5, include_host_details=True)

# Test date ranges with known data
search_hosts_by_vulnerabilities("created_timestamp:>'2024-01-01T00:00:00Z'", limit=10)
```

## Integration with Other Tools

### Workflow Integration

```python
# 1. Find vulnerable hosts
vulnerable_hosts = search_hosts_by_vulnerabilities("cve.severity:'CRITICAL'+status:'open'")

# 2. Get detailed information for priority hosts
get_host_details("host_id_from_results")

# 3. Check for recent security events
get_host_events("host_id_from_results", limit=20)

# 4. Use advanced host search for additional filtering
search_hosts_advanced("device_id:'host_id_from_results'", include_details=True)
```

### Compliance Reporting

```python
# Monthly vulnerability exposure report
monthly_report = search_hosts_by_vulnerabilities(
    "created_timestamp:>'2024-01-01T00:00:00Z'",
    limit=500,
    include_vulnerability_details=True
)

# Critical asset vulnerability status
critical_assets = search_hosts_by_vulnerabilities(
    "host_info.asset_criticality:['Critical']+status:'open'",
    include_host_details=True
)
```

## Best Practices

1. **Start specific** - Use severity and status filters first
2. **Filter by time** - Focus on recent vulnerabilities for current risk
3. **Use appropriate limits** - Balance thoroughness with performance
4. **Combine with host tools** - Use other MCP tools for complete analysis
5. **Monitor trends** - Regular searches to track vulnerability exposure
6. **Document filters** - Save working filter expressions for reuse
7. **Test incrementally** - Build complex queries step by step
8. **Consider context** - Factor in asset criticality and exposure

This tool provides powerful vulnerability-based host discovery capabilities that complement the existing host search functionality, enabling comprehensive security analysis and remediation planning. 