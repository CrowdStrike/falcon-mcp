# üöÄ New Enhancement: Host Vulnerability Search

## What Was Added

A powerful new MCP tool called `search_hosts_by_vulnerabilities` that enables searching for hosts based on their vulnerability exposure using CrowdStrike Spotlight.

## üéØ Addresses Your Specific Requirements

### 1. Search for hosts with CVE-2025123
```python
search_hosts_by_vulnerabilities("cve.id:['CVE-2025123']")
```

### 2. Search for hosts with open critical vulnerabilities  
```python
search_hosts_by_vulnerabilities("status:'open'+cve.severity:'CRITICAL'")
```

## üî• Additional Powerful Search Examples

### Exploit-Based Searches
```python
# Hosts with actively exploited vulnerabilities (highest priority)
search_hosts_by_vulnerabilities("cve.exploit_status:'90'+status:'open'")

# Hosts with CISA Known Exploited Vulnerabilities
search_hosts_by_vulnerabilities("cve.is_cisa_kev:true+status:'open'")

# Hosts with any known exploits (not just theoretical)
search_hosts_by_vulnerabilities("cve.exploit_status:!'0'+status:'open'")
```

### Platform-Specific Vulnerability Searches
```python
# Windows servers with critical vulnerabilities
search_hosts_by_vulnerabilities("host_info.platform_name:'Windows'+cve.severity:'CRITICAL'+status:'open'")

# Linux hosts with high or critical vulnerabilities
search_hosts_by_vulnerabilities("host_info.platform_name:'Linux'+cve.severity:['HIGH','CRITICAL']+status:'open'")

# Internet-exposed hosts with any vulnerabilities (highest risk)
search_hosts_by_vulnerabilities("host_info.internet_exposure:'Yes'+status:'open'")
```

### Risk-Based Prioritization
```python
# Critical production systems with vulnerabilities
search_hosts_by_vulnerabilities("host_info.tags:['production']+cve.severity:'CRITICAL'+status:'open'")

# Unmanaged assets with high-severity vulnerabilities
search_hosts_by_vulnerabilities("host_info.managed_by:'Unmanaged'+cve.severity:['HIGH','CRITICAL']")

# Critical assets with any open vulnerabilities
search_hosts_by_vulnerabilities("host_info.asset_criticality:['Critical','High']+status:'open'")
```

### Time-Based Vulnerability Analysis
```python
# Recently discovered critical vulnerabilities (last 30 days)
search_hosts_by_vulnerabilities("created_timestamp:>'2024-01-15T00:00:00Z'+cve.severity:'CRITICAL'+status:'open'")

# Old unpatched vulnerabilities (over 6 months old)
search_hosts_by_vulnerabilities("created_timestamp:<'2023-07-01T00:00:00Z'+status:'open'")

# Vulnerabilities updated recently (potential new exploit intelligence)
search_hosts_by_vulnerabilities("updated_timestamp:>'2024-01-15T00:00:00Z'+status:'open'")
```

### ExPRT Rating Searches (CrowdStrike's AI Risk Rating)
```python
# Hosts with ExPRT high-rated vulnerabilities
search_hosts_by_vulnerabilities("cve.exprt_rating:'HIGH'+status:'open'")

# Hosts with ExPRT critical-rated vulnerabilities
search_hosts_by_vulnerabilities("cve.exprt_rating:'CRITICAL'+status:'open'")

# Any ExPRT-rated vulnerabilities except unknown
search_hosts_by_vulnerabilities("cve.exprt_rating:!'UNKNOWN'+status:'open'")
```

### Complex Multi-Criteria Searches
```python
# Emergency response: Critical + Exploited + Internet-exposed
search_hosts_by_vulnerabilities(
    "cve.severity:'CRITICAL'+cve.exploit_status:['60','90']+host_info.internet_exposure:'Yes'+status:'open'",
    include_host_details=True,
    include_vulnerability_details=True
)

# Compliance check: CISA KEV on Windows production systems
search_hosts_by_vulnerabilities(
    "cve.is_cisa_kev:true+host_info.platform_name:'Windows'+host_info.tags:['production']+status:'open'"
)

# Patch prioritization: High/Critical vulnerabilities on managed systems
search_hosts_by_vulnerabilities(
    "cve.severity:['HIGH','CRITICAL']+host_info.managed_by:'Falcon sensor'+status:'open'",
    sort="created_timestamp.desc"
)
```

## üõ†Ô∏è Implementation Details

### Architecture
- **New MCP Tool**: `search_hosts_by_vulnerabilities()` in `src/api/server.py`
- **Business Logic**: Added to `HostManager` class in `src/core/host_manager.py`
- **API Integration**: Extended `FalconClient` with Spotlight Vulnerabilities service
- **Documentation**: Comprehensive guide in `VULNERABILITY_SEARCH_GUIDE.md`

### How It Works
1. **Vulnerability Query**: Searches CrowdStrike Spotlight using your filter criteria
2. **Host Extraction**: Extracts unique Agent IDs (AIDs) from vulnerability results
3. **Host Details**: Retrieves comprehensive host information for affected systems
4. **Combined Output**: Provides unified vulnerability + host analysis

### Key Features
- **Comprehensive Filtering**: 30+ vulnerability properties including CVE, severity, exploit status, platform
- **Smart Analytics**: Severity distribution, platform breakdown, CVE analysis
- **Flexible Output**: Summary tables or detailed vulnerability/host information
- **Performance Optimized**: Efficient processing of large vulnerability datasets
- **Time-based Prioritization**: Sort by creation time, closure time, or update time

## üìä Output Examples

### Summary View (Default)
```
# üîé CrowdStrike Falcon - Hosts by Vulnerabilities Search Results

## üìä Results Summary
‚Ä¢ Vulnerabilities Found: 45
‚Ä¢ Unique Hosts Affected: 23

## üìà Vulnerability Analysis
### Severity Distribution
‚Ä¢ CRITICAL: 12 vulnerabilities
‚Ä¢ HIGH: 18 vulnerabilities  
‚Ä¢ MEDIUM: 15 vulnerabilities

### Platform Distribution
‚Ä¢ Windows: 28 vulnerabilities
‚Ä¢ Linux: 17 vulnerabilities

## üñ•Ô∏è Affected Hosts
#   Hostname                  Platform   Vuln Count Most Severe  Host ID
1   web-server-01            Windows    4          CRITICAL      a1b2c3d4...
2   db-primary-prod          Linux      3          HIGH          e5f6g7h8...
3   app-server-02            Windows    2          CRITICAL      i9j0k1l2...

## üö® CVE Summary
### Top CVEs by Host Count
‚Ä¢ CVE-2024-1234: 12 hosts affected
‚Ä¢ CVE-2024-5678: 8 hosts affected

### Critical CVEs Found
‚Ä¢ CVE-2024-1234: 12 hosts affected
‚Ä¢ CVE-2024-9999: 5 hosts affected
```

### Detailed Analysis Mode
```python
# Get comprehensive details
search_hosts_by_vulnerabilities(
    "cve.severity:'CRITICAL'+status:'open'",
    include_host_details=True,
    include_vulnerability_details=True
)
```

## üéâ Benefits

### For Security Operations
- **Rapid Response**: Quickly identify all hosts affected by specific CVEs
- **Risk Assessment**: Prioritize remediation based on exploit status and severity
- **Compliance**: Track CISA KEV vulnerabilities and critical asset exposure
- **Threat Hunting**: Correlate vulnerabilities with host characteristics

### For Vulnerability Management
- **Patch Planning**: Identify systems needing specific patches
- **Asset Inventory**: Map vulnerabilities to business-critical systems
- **Trend Analysis**: Track vulnerability exposure over time
- **Risk Scoring**: Combine vulnerability severity with host criticality

### For Incident Response
- **Scope Assessment**: Determine blast radius of new vulnerability disclosures
- **Containment Planning**: Identify high-risk systems for isolation
- **Evidence Collection**: Correlate vulnerabilities with host events
- **Communication**: Generate executive reports on exposure

## üîó Integration Workflow

The new tool works seamlessly with existing functionality:

```python
# 1. Find vulnerable hosts
vulnerable_hosts = search_hosts_by_vulnerabilities("cve.severity:'CRITICAL'+status:'open'")

# 2. Get detailed host information  
get_host_details("host_id_from_results")

# 3. Check for related security events
get_host_events("host_id_from_results")

# 4. Advanced host filtering
search_hosts_advanced("device_id:'host_id_from_results'", include_details=True)
```

## üìà Performance Characteristics

- **Efficient API Usage**: Batched host lookups minimize API calls
- **Smart Caching**: Reuses host data for multiple vulnerabilities per host
- **Configurable Limits**: Balance thoroughness with response time
- **Error Handling**: Graceful handling of assets without Falcon sensors

## üîí Security Considerations

- **Scope Aware**: Respects CrowdStrike customer boundaries
- **Data Minimization**: Only retrieves necessary host information
- **Error Resilience**: Continues processing if some hosts are inaccessible
- **Audit Trail**: Comprehensive logging of search operations

This enhancement transforms the MCP from basic host lookup to comprehensive vulnerability risk assessment, enabling proactive security management and rapid incident response. 